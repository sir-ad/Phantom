name: Publish to NPM

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: npm install
        
      - name: Build packages
        run: npm run build
        
      - name: Publish all packages
        run: |
          PACKAGES=("memory" "core" "adapters" "agent-communicator" "browser-agent" "chat-server" "discovery-loop" "docs-engine" "feedback-hub" "integrations" "interview-analyzer" "usage-intelligence" "mcp-server" "os-agent" "modules" "tui" "cli")
          for pkg in "${PACKAGES[@]}"; do
            echo "---------------------------------------------------"
            echo "ðŸš€ Publishing @phantom-pm/$pkg..."
            echo "---------------------------------------------------"
            cd packages/$pkg
            
            # Check if package is already published to avoid errors on retry
            VERSION=$(npm pkg get version | tr -d '"')
            
            # Publish with provenance (requires id-token: write)
            # Use 'latest' tag for stable, 'next' for pre-releases
            if [[ $VERSION == *"-beta"* ]] || [[ $VERSION == *"-alpha"* ]]; then
              npm publish --access public --tag latest
            else
              npm publish --access public
            fi
            
            cd ../..
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
